<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Extreme Team Folding</title>

    <!-- TODO: [zodac] Can't figure out how to link to these resources, probably because I'm serving the main page from JAX-RS -->
    <!-- Rather than try and expose more static content through REST, look into moving this to a NodeJS/React container later -->
    <link rel="shortcut icon" type="image/x-icon"
          href="https://extremehw-forums.s3.eu-west-2.amazonaws.com/monthly_2020_09/EHW_152x152.png.b3f456e5c0204c6622cc5be26178da26.png">
    <link rel="stylesheet" href="https://getbootstrap.com/docs/4.0/dist/css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <style>
        body {
          background-color: #282424;
          color: #F2FCFF;
          margin:10px;
          padding:5px;
        }

        th {
            cursor: pointer;
        }



















































































    </style>
</head>

<script>
    // The 'toggle' functions below simply change the colour of the buttons. There must be a smarter way to do this...
    function toggleStats() {
        if($("#stats_div").is(":visible")){
            $("#stats_button").addClass("btn-primary");
            $("#stats_button").removeClass("btn-success");
        } else {
            $("#stats_button").removeClass("btn-primary");
            $("#stats_button").addClass("btn-success");
        }
    }

    function toggleHardware() {
        if($("#hardware_div").is(":visible")){
            $("#hardware_button").addClass("btn-primary");
            $("#hardware_button").removeClass("btn-success");
        } else {
            $("#hardware_button").removeClass("btn-primary");
            $("#hardware_button").addClass("btn-success");
        }
    }

    function toggleUsers() {
        if($("#users_div").is(":visible")){
            $("#users_button").addClass("btn-primary");
            $("#users_button").removeClass("btn-success");
        } else {
            $("#users_button").removeClass("btn-primary");
            $("#users_button").addClass("btn-success");
        }
    }

    function toggleTeams() {
        if($("#teams_div").is(":visible")){
            $("#teams_button").addClass("btn-primary");
            $("#teams_button").removeClass("btn-success");
        } else {
            $("#teams_button").removeClass("btn-primary");
            $("#teams_button").addClass("btn-success");
        }
    }

    function toggleTeam(teamNumber) {
        if($("#team_"+teamNumber+"_subdiv").is(":visible")){
            $("#team_"+teamNumber+"_button").addClass("btn-primary");
            $("#team_"+teamNumber+"_button").removeClass("btn-success");
        } else {
            $("#team_"+teamNumber+"_button").removeClass("btn-primary");
            $("#team_"+teamNumber+"_button").addClass("btn-success");
        }
    }

    // Straight lifted/stole this code from W3 Schools: https://www.w3schools.com/howto/howto_js_sort_table.asp
    function sortTable(columnIndex, tableId) {
      var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
      table = document.getElementById(tableId);
      switching = true;
      // Set the sorting direction to ascending:
      dir = "asc";
      /* Make a loop that will continue until
      no switching has been done: */
      while (switching) {
        // Start by saying: no switching is done:
        switching = false;
        rows = table.rows;
        /* Loop through all table rows (except the
        first, which contains table headers): */
        for (i = 1; i < (rows.length - 1); i++) {
          // Start by saying there should be no switching:
          shouldSwitch = false;
          /* Get the two elements you want to compare,
          one from current row and one from the next: */
          x = rows[i].getElementsByTagName("TD")[columnIndex];
          y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
          /* Check if the two rows should switch place,
          based on the direction, asc or desc: */
          if (dir == "asc") {
            if (isNaN(x.innerHTML) || isNaN(y.innerHTML)){
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                  // If so, mark as a switch and break the loop:
                  shouldSwitch = true;
                  break;
                }
            } else {
                if (parseInt(x.innerHTML) > parseInt(y.innerHTML)) {
                  // If so, mark as a switch and break the loop:
                  shouldSwitch = true;
                  break;
                }
            }
          } else if (dir == "desc") {
            if (isNaN(x.innerHTML) || isNaN(y.innerHTML)){
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                  // If so, mark as a switch and break the loop:
                  shouldSwitch = true;
                  break;
                }
            } else {
                if (parseInt(x.innerHTML) < parseInt(y.innerHTML)) {
                  // If so, mark as a switch and break the loop:
                  shouldSwitch = true;
                  break;
                }
            }
          }
        }
        if (shouldSwitch) {
          /* If a switch has been marked, make the switch
          and mark that a switch has been done: */
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          // Each time a switch is done, increase this count by 1:
          switchcount ++;
        } else {
          /* If no switching has been done AND the direction is "asc",
          set the direction to "desc" and run the while loop again. */
          if (switchcount == 0 && dir == "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

    // Stolen code, again: https://stackoverflow.com/questions/37179899/countdown-timer-every-hour-but-on-30-minute-marks
    function updateTime() {
        const zeroPad = (num, places) => String(num).padStart(places, '0')
        var time = new Date(),
        secsRemaining = 3600 - (time.getUTCMinutes()-15)%60 * 60 - time.getUTCSeconds();
        mins = Math.floor(secsRemaining / 60) % 60;
        secs = secsRemaining % 60;
        $("#min-part").text(mins);
        $("#sec-part").text(zeroPad(secs, 2));

        setTimeout( updateTime, 1000 - (new Date()).getUTCMilliseconds() );
    }

    function sortJsonByKey(key) {
        return function(a, b) {
            if (a[key] > b[key]) {
                return 1;
            }
            if (a[key] < b[key]) {
                return -1;
            }
            return 0;
        }
    }

    // Pull the TC stats, then manually update each of the numeric fields to be formatted with commas
    async function loadTcStats() {
        const publicUrl='../tc_stats';
        const localUrl='http://127.0.0.1:8080/folding/tc_stats';

        fetch(publicUrl)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return fetch(localUrl)
                .then(function(response) {
                    return response.json();
                });
            }
        })
        .then(function(jsonResponse) {
            // Build competition stats
            const statsTableHeaders = ["Total Points", "Total Units"];
            const statsTableTeamProperties = ["totalMultipliedPoints", "totalUnits"];

            statsDiv = document.createElement('div');
            statsDiv.setAttribute("id", "stats_div");
            statsDiv.setAttribute("class", "collapse show");

            statsTitle = document.createElement('h2');
            statsTitle.setAttribute("class", "navbar-brand");
            statsTitle.innerHTML = "Overall Stats";
            statsDiv.append(statsTitle);

            statsTable = document.createElement('table');
            statsTable.setAttribute("id", "stats");
            statsTable.setAttribute("class", "table table-striped table-hover");

            statsTableHead = document.createElement('thead');
            statsTableHeaderRow = document.createElement('tr');
            statsTableHeaders.forEach(function (header, i) {
                statsTableHeader = document.createElement("th");
                statsTableHeader.setAttribute("onclick", "sortTable("+i+", 'stats')");
                statsTableHeader.setAttribute("scope", "col");
                statsTableHeader.innerHTML = header;

                statsTableHeaderRow.append(statsTableHeader);
            });
            statsTableHead.append(statsTableHeaderRow);
            statsTable.append(statsTableHead);


            statsTableBody = document.createElement('tbody');
            statsTableBodyRow = document.createElement('tr');
            statsTableTeamProperties.forEach(function (teamProperty, i) {
                statsTableBodyCell = document.createElement("td");
                statsTableBodyCell.innerHTML = jsonResponse[teamProperty].toLocaleString();

                statsTableBodyRow.append(statsTableBodyCell);
            });
            statsTableBody.append(statsTableBodyRow);
            statsTable.append(statsTableBody);


            statsDiv.append(statsTable);


            // Build team tables
            const teamTableHeaders = ["Rank", "User", "Category", "Hardware", "Points", "Units"];
            const teamTableUserProperties = ["rankInTeam", "userName", "category", "hardware", "multipliedPoints", "units"];

            var jsonResponseTeams = jsonResponse['teams'];
            jsonResponseTeams.sort(sortJsonByKey("rank"));
            $.each(jsonResponseTeams, function(i, team) {
                var teamNumber = (i+1);

                teamDiv = document.createElement('div');
                teamDiv.setAttribute("id", "team_"+teamNumber+"_div");

                metadataDiv = document.createElement('div');
                metadataDiv.setAttribute("id", "team_"+teamNumber+"_metadata")

                teamTitle = document.createElement('h2');
                teamTitle.innerHTML = "Rank #" + team['rank'] + ": " + team['teamName'] + " (Captain: " + team['captainName'] + ")";
                metadataDiv.append(teamTitle);

                teamStats = document.createElement('h5');
                teamStats.setAttribute("id", "team_"+teamNumber+"_stats");
                teamStats.innerHTML = team['teamMultipliedPoints'].toLocaleString() + " points | " + team['teamUnits'].toLocaleString() + " units";
                metadataDiv.append(teamStats);

                teamButton = document.createElement('button');
                teamButton.setAttribute("id", "team_"+teamNumber+"_button");
                teamButton.setAttribute("class", "btn ui-btn btn-primary");
                teamButton.setAttribute("href", "#team_"+teamNumber+"_subdiv");
                teamButton.setAttribute("onclick", "toggleTeam("+teamNumber+")");
                teamButton.setAttribute("data-toggle", "collapse");
                teamButton.setAttribute("role", "button");
                teamButton.innerHTML = "Show/Hide";
                metadataDiv.append(teamButton);
                teamDiv.append(metadataDiv);

                subDiv = document.createElement('div');
                subDiv.setAttribute("id", "team_"+teamNumber+"_subdiv");
                subDiv.setAttribute("class", "collapse");

                teamTable = document.createElement('table');
                teamTable.setAttribute("id", "team_"+teamNumber);
                teamTable.setAttribute("class", "table table-striped table-hover");

                teamTableHead = document.createElement("thead");
                teamTableHeaderRow = document.createElement("tr");
                teamTableHeaders.forEach(function (header, i) {
                    teamTableHeaderCell = document.createElement("th");
                    teamTableHeaderCell.setAttribute("onclick", "sortTable("+i+", 'team_"+teamNumber+"')");
                    teamTableHeaderCell.setAttribute("scope", "col");
                    teamTableHeaderCell.innerHTML = header;

                    teamTableHeaderRow.append(teamTableHeaderCell);
                });
                teamTableHead.append(teamTableHeaderRow);
                teamTable.append(teamTableHead);


                teamTableBody = document.createElement("tbody");

                activeUsers = team['activeUsers'];
                activeUsers.forEach(function (activeUser, i) {
                    teamTableBodyRow = document.createElement("tr");

                    teamTableUserProperties.forEach(function (userProperty, i) {
                        teamTableUserCell = document.createElement("td");

                        if(userProperty === "multipliedPoints"){
                            teamTableUserCell.setAttribute("data-toggle", "tooltip");
                            teamTableUserCell.setAttribute("data-placement", "left");
                            teamTableUserCell.setAttribute("title", "Unmultiplied: " + activeUser["points"].toLocaleString());
                            $('[data-toggle="tooltip"]').tooltip();
                        }

                        teamTableUserCell.innerHTML = activeUser[userProperty].toLocaleString();
                        teamTableBodyRow.append(teamTableUserCell);
                    });
                    teamTableBody.append(teamTableBodyRow);
                });

                retiredUsers = team['retiredUsers'];
                retiredUsers.forEach(function (retiredUser, i) {
                    teamTableBodyRow = document.createElement("tr");

                    teamTableUserProperties.forEach(function (userProperty, i) {
                        teamTableUserRow = document.createElement("td");
                        if(userProperty === "userName"){
                            teamTableUserRow.innerHTML = retiredUser[userProperty] + " (retired)";
                        } else {
                            if(userProperty === "multipliedPoints"){
                                teamTableUserCell.setAttribute("data-toggle", "tooltip");
                                teamTableUserCell.setAttribute("data-placement", "left");
                                teamTableUserCell.setAttribute("title", "Unmultiplied: " + retiredUser["points"].toLocaleString());
                                $('[data-toggle="tooltip"]').tooltip();
                            }

                            teamTableUserRow.innerHTML = retiredUser[userProperty].toLocaleString();
                        }
                        teamTableBodyRow.append(teamTableUserRow);
                    });
                    teamTableBody.append(teamTableBodyRow);
                });
                teamTable.append(teamTableBody);
                subDiv.append(teamTable);

                teamDiv.append(subDiv);

                statsDiv.append(teamDiv);
                statsDiv.append(document.createElement('br'));

                document.body.appendChild(statsDiv);
            });
        })
    };

    async function loadHardware() {
        const publicUrl='../hardware';
        const localUrl='http://127.0.0.1:8080/folding/hardware';

        fetch(publicUrl)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return fetch(localUrl)
                .then(function(response) {
                    return response.json();
                });
            }
        })
        .then(function(jsonResponse) {
            // Build hardware
            jsonResponse.sort(sortJsonByKey("id"));
            const hardwareHeaders = ["ID", "Name", "Operating System", "Multiplier"];
            const hardwareProperties = ["id", "displayName", "operatingSystem", "multiplier"];
            
            hardwareDiv = document.createElement('div');
            hardwareDiv.setAttribute("id", "hardware_div");
            hardwareDiv.setAttribute("class", "collapse");

            hardwareTitle = document.createElement('h2');
            hardwareTitle.setAttribute("class", "navbar-brand");
            hardwareTitle.innerHTML = "Hardware";
            hardwareDiv.append(hardwareTitle);
            
            hardwareTable = document.createElement('table');
            hardwareTable.setAttribute("id", "hardware");
            hardwareTable.setAttribute("class", "table table-striped table-hover");
            
            hardwareTableHead = document.createElement('thead');
            hardwareTableHeaderRow = document.createElement('tr');
            hardwareHeaders.forEach(function (header, i) {
                hardwareTableHeader = document.createElement("th");
                hardwareTableHeader.setAttribute("onclick", "sortTable("+i+", 'hardware')");
                hardwareTableHeader.setAttribute("scope", "col");
                hardwareTableHeader.innerHTML = header;

                hardwareTableHeaderRow.append(hardwareTableHeader);
            });
            hardwareTableHead.append(hardwareTableHeaderRow);
            hardwareTable.append(hardwareTableHead);


            hardwareTableBody = document.createElement('tbody');

            $.each(jsonResponse, function(i, hardwareItem) {
                hardwareTableBodyRow = document.createElement('tr');
                hardwareProperties.forEach(function (hardwareProperty, i) {
                    hardwareTableBodyCell = document.createElement("td");

                    if(hardwareProperty === "multiplier"){
                        hardwareTableBodyCell.innerHTML = "x" + hardwareItem[hardwareProperty].toLocaleString();
                    } else {
                        hardwareTableBodyCell.innerHTML = hardwareItem[hardwareProperty].toLocaleString();
                    }

                    hardwareTableBodyRow.append(hardwareTableBodyCell);
                });
                hardwareTableBody.append(hardwareTableBodyRow);
            });
            hardwareTable.append(hardwareTableBody);
            
            hardwareDiv.append(hardwareTable);
            
            document.body.appendChild(hardwareDiv);
        })
    };

    async function loadUsers() {
        const publicUrl='../users';
        const localUrl='http://127.0.0.1:8080/folding/users';

        fetch(publicUrl)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return fetch(localUrl)
                .then(function(response) {
                    return response.json();
                });
            }
        })
        .then(function(jsonResponse) {
            // Build users
            jsonResponse.sort(sortJsonByKey("id"));
            const usersHeaders = ["ID", "User", "Passkey", "Category", "Hardware ID", "Live Stats Link"];
            const usersProperties = ["id", "displayName", "passkey", "category", "hardwareId", "liveStatsLink"];
            
            usersDiv = document.createElement('div');
            usersDiv.setAttribute("id", "users_div");
            usersDiv.setAttribute("class", "collapse");

            usersTitle = document.createElement('h2');
            usersTitle.setAttribute("class", "navbar-brand");
            usersTitle.innerHTML = "Users";
            usersDiv.append(usersTitle);
            
            usersTable = document.createElement('table');
            usersTable.setAttribute("id", "users");
            usersTable.setAttribute("class", "table table-striped table-hover");
            
            usersTableHead = document.createElement('thead');
            usersTableHeaderRow = document.createElement('tr');
            usersHeaders.forEach(function (header, i) {
                usersTableHeader = document.createElement("th");
                usersTableHeader.setAttribute("onclick", "sortTable("+i+", 'users')");
                usersTableHeader.setAttribute("scope", "col");
                usersTableHeader.innerHTML = header;

                usersTableHeaderRow.append(usersTableHeader);
            });
            usersTableHead.append(usersTableHeaderRow);
            usersTable.append(usersTableHead);


            usersTableBody = document.createElement('tbody');

            $.each(jsonResponse, function(i, usersItem) {
                usersTableBodyRow = document.createElement('tr');
                usersProperties.forEach(function (usersProperty, i) {
                    usersTableBodyCell = document.createElement("td");

                    if (usersProperty === "liveStatsLink") {
                        if (usersProperty in usersItem) {
                            liveStatsLink = document.createElement('a');
                            liveStatsLink.setAttribute("href", usersItem[usersProperty]);
                            liveStatsLink.innerHTML = usersItem[usersProperty];

                            usersTableBodyCell.append(liveStatsLink);
                        }
                    } else {
                        usersTableBodyCell.innerHTML = usersItem[usersProperty].toLocaleString();
                    }
                    usersTableBodyRow.append(usersTableBodyCell);
                });
                usersTableBody.append(usersTableBodyRow);
            });
            usersTable.append(usersTableBody);
            
            usersDiv.append(usersTable);
            
            document.body.appendChild(usersDiv);
        })
    };

    async function loadTeams() {
        const publicUrl='../teams';
        const localUrl='http://127.0.0.1:8080/folding/teams';

        fetch(publicUrl)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return fetch(localUrl)
                .then(function(response) {
                    return response.json();
                });
            }
        })
        .then(function(jsonResponse) {
            // Build teams
            jsonResponse.sort(sortJsonByKey("id"));
            const teamsHeaders = ["ID", "Name", "Description", "Captain ID", "User IDs", "Retired User IDs"];
            const teamsProperties = ["id", "teamName", "teamDescription", "captainUserId", "userIds", "retiredUserIds"];
            
            teamsDiv = document.createElement('div');
            teamsDiv.setAttribute("id", "teams_div");
            teamsDiv.setAttribute("class", "collapse");

            teamsTitle = document.createElement('h2');
            teamsTitle.setAttribute("class", "navbar-brand");
            teamsTitle.innerHTML = "Teams";
            teamsDiv.append(teamsTitle);
            
            teamsTable = document.createElement('table');
            teamsTable.setAttribute("id", "teams");
            teamsTable.setAttribute("class", "table table-striped table-hover");
            
            teamsTableHead = document.createElement('thead');
            teamsTableHeaderRow = document.createElement('tr');
            teamsHeaders.forEach(function (header, i) {
                teamsTableHeader = document.createElement("th");
                teamsTableHeader.setAttribute("onclick", "sortTable("+i+", 'teams')");
                teamsTableHeader.setAttribute("scope", "col");
                teamsTableHeader.innerHTML = header;

                teamsTableHeaderRow.append(teamsTableHeader);
            });
            teamsTableHead.append(teamsTableHeaderRow);
            teamsTable.append(teamsTableHead);


            teamsTableBody = document.createElement('tbody');

            $.each(jsonResponse, function(i, teamsItem) {
                teamsTableBodyRow = document.createElement('tr');
                teamsProperties.forEach(function (teamsProperty, i) {
                    teamsTableBodyCell = document.createElement("td");

                    if (teamsProperty === "liveStatsLink") {
                        if (teamsProperty in teamsItem) {
                            liveStatsLink = document.createElement('a');
                            liveStatsLink.setAttribute("href", teamsItem[teamsProperty]);
                            liveStatsLink.innerHTML = teamsItem[teamsProperty];

                            teamsTableBodyCell.append(liveStatsLink);
                        }
                    } else {
                        teamsTableBodyCell.innerHTML = teamsItem[teamsProperty].toLocaleString();
                        teamsTableBodyRow.append(teamsTableBodyCell);
                    }
                });
                teamsTableBody.append(teamsTableBodyRow);
            });
            teamsTable.append(teamsTableBody);
            
            teamsDiv.append(teamsTable);
            
            document.body.appendChild(teamsDiv);
        })
    };

    $(document).ready(function() {
        loadTcStats();
        loadHardware();
        loadUsers();
        loadTeams();
        updateTime();
    });





















































































</script>


<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
        <!--        <strike>-->
        Extreme Team Folding
        <!--        </strike>-->
        <!--        <span style="color:red">zodac's test hub</span>-->
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="#">TC Stats</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#">Admin</a>
            </li>
        </ul>
    </div>
    <div style="position: relative; right: 0px;">Next update: <span id="min-part"></span>:<span id="sec-part"></span>
    </div>
</nav>


<body>
<button onclick="toggleStats()" class="btn btn-success" id="stats_button" href="#stats_div"
        data-toggle="collapse" role="button">Team Competition
    Stats
</button>
<button onclick="toggleHardware()" class="btn btn-primary" id="hardware_button" href="#hardware_div"
        data-toggle="collapse" role="button">List of Hardware
</button>
<button onclick="toggleUsers()" class="btn btn-primary" id="users_button" href="#users_div"
        data-toggle="collapse" role="button">List of Users
</button>
<button onclick="toggleTeams()" class="btn btn-primary" id="teams_button" href="#teams_div"
        data-toggle="collapse" role="button">List of Teams
</button>
</body>
</html>